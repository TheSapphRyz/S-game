#define GRAPHICS_API_VULKAN
#include <raylib.h>
#include <raymath.h>
#include <vector>
#include <iostream>
#include <raygui.h>


const int MAP_SIZE = 30; 

struct WorldObject {
    Vector3 position;
    bool active;
    int type; // 0 - дерево, 1 - цветок
};

float GetHeightAt(float heights[MAP_SIZE][MAP_SIZE], float x, float z) {
    if (x < 0 || x >= MAP_SIZE - 1 || z < 0 || z >= MAP_SIZE - 1) return 0.0f;
    int xi = (int)x;
    int zi = (int)z;
    float dx = x - xi;
    float dz = z - zi;
    float h1 = heights[xi][zi] * (1 - dx) + heights[xi + 1][zi] * dx;
    float h2 = heights[xi][zi + 1] * (1 - dx) + heights[xi + 1][zi + 1] * dx;
    return h1 * (1 - dz) + h2 * dz;
}

int main() {
    SetConfigFlags(FLAG_WINDOW_RESIZABLE);
    InitWindow(1920, 1080, "S-game");
    Image perlinImage = GenImagePerlinNoise(MAP_SIZE, MAP_SIZE, 0, 0, 5.0f);
    Color* pixels = LoadImageColors(perlinImage);
    float heights[MAP_SIZE][MAP_SIZE];
    for (int y = 0; y < MAP_SIZE; y++) {
        for (int x = 0; x < MAP_SIZE; x++) {
            heights[x][y] = (pixels[y * MAP_SIZE + x].r / 255.0f) * 4.0f;
        }
    }
    UnloadImageColors(pixels);
    UnloadImage(perlinImage);
    Image kopImg = LoadImage("resources/kopatych.png");
    ImageFormat(&kopImg, PIXELFORMAT_UNCOMPRESSED_R8G8B8A8);
    Texture2D charTex = LoadTextureFromImage(kopImg);
    Texture2D treeTex = LoadTexture("resources/tree-kust.png");
    Shader alphaShader = LoadShader(0, "shader.fs");
    Texture2D grassTex = LoadTexture("resources/grass.png");
    SetTextureWrap(grassTex, TEXTURE_WRAP_CLAMP);
    GenTextureMipmaps(&grassTex);
    SetTextureFilter(grassTex, TEXTURE_FILTER_BILINEAR);
    Mesh groundMesh = GenMeshHeightmap(perlinImage, { (float)MAP_SIZE, 1.0f, (float)MAP_SIZE });
    Model groundModel = LoadModelFromMesh(groundMesh);
    groundModel.materials[0].maps[MATERIAL_MAP_DIFFUSE].texture = grassTex;
    Camera3D camera = { { 20, 20, 20 }, { 15, 0, 15 }, { 0, 1, 0 }, 15.0f, CAMERA_ORTHOGRAPHIC };
    Vector2 playerPos = { 15.0f, 15.0f };
    std::vector<WorldObject> objects;
    for (int i = 0; i < 15; i++) {
        float rx = (float)GetRandomValue(2, MAP_SIZE - 2);
        float rz = (float)GetRandomValue(2, MAP_SIZE - 2);
        objects.push_back({ { rx, GetHeightAt(heights, rx, rz), rz }, true, 0 });
    }
    SetTargetFPS(60);
    while (!WindowShouldClose()) {
        if (IsKeyPressed(KEY_F11)) ToggleFullscreen();
        float dt = GetFrameTime();
        Vector2 moveDir = { 0 };
        if (IsKeyDown(KEY_W)) moveDir.y -= 1;
        if (IsKeyDown(KEY_S)) moveDir.y += 1;
        if (IsKeyDown(KEY_A)) moveDir.x -= 1;
        if (IsKeyDown(KEY_D)) moveDir.x += 1;
        if (Vector2Length(moveDir) > 0) {
            moveDir = Vector2Normalize(moveDir);
            float nextX = playerPos.x + moveDir.x * 5.0f * dt;
            float nextZ = playerPos.y + moveDir.y * 5.0f * dt;
            if (nextX >= 0 && nextX < MAP_SIZE - 1) playerPos.x = nextX;
            if (nextZ >= 0 && nextZ < MAP_SIZE - 1) playerPos.y = nextZ;
        }
        float currentH = GetHeightAt(heights, playerPos.x, playerPos.y);
        camera.target = { playerPos.x, currentH, playerPos.y };
        camera.position = Vector3Add(camera.target, { 15, 15, 15 });
        if (IsMouseButtonPressed(MOUSE_LEFT_BUTTON)) {
            Ray ray = GetMouseRay(GetMousePosition(), camera);
            for (auto& obj : objects) {
                if (obj.active) {
                    RayCollision coll = GetRayCollisionSphere(ray, { obj.position.x, obj.position.y + 1.0f, obj.position.z }, 0.8f);
                    if (coll.hit) {
                        obj.active = false;
                        std::cout << "Объект собран!" << std::endl;
                    }
                }
            }
        }

        BeginDrawing();
        ClearBackground(SKYBLUE);
        BeginMode3D(camera);
        BeginShaderMode(alphaShader);

        DrawModel(groundModel, { 0, 0, 0 }, 1.0f, WHITE);

        for (auto& obj : objects) {
            if (obj.active) {
                DrawBillboard(camera, treeTex, { obj.position.x, obj.position.y + 2.0f, obj.position.z }, 4.0f, WHITE);
            }
        }

        DrawBillboard(camera, charTex, { playerPos.x, currentH + 0.8f, playerPos.y }, 1.5f, WHITE);

        EndShaderMode();
        EndMode3D();
        DrawText("Кликни на дерево, чтобы собрать его", 10, 10, 20, WHITE);
        EndDrawing();
    }

    UnloadTexture(charTex);
    UnloadTexture(treeTex);
    CloseWindow();
    return 0;
}
